<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- ================================================================
         CAMPOS DE EXPORTACIÓN FEL EN PESTAÑA "OTRA INFORMACIÓN"
         ================================================================ -->
    <record id="view_move_form_inherit_export_fields" model="ir.ui.view">
        <field name="name">account.move.form.export.fields</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="priority">95</field>
        <field name="arch" type="xml">
            <!-- Agregar grupo de exportación FEL en pestaña Otra Información -->
            <xpath expr="//page[@id='other_tab']//group[@id='other_tab_group']" position="after">
                <field name="is_export_invoice" invisible="1"/>
                <group string="Datos de Exportación FEL" name="export_fel_group"
                       invisible="not is_export_invoice">
                    <group>
                        <field name="otra_referencia_fel"/>
                    </group>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Agregar botón "Anular FEL" en el formulario de factura -->
    <record id="view_move_form_inherit_cancel_fel" model="ir.ui.view">
        <field name="name">account.move.form.cancel.fel</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <!-- Agregar botón después del botón de enviar -->
            <xpath expr="//button[@name='action_post']" position="after">
                <button name="action_open_cancel_fel_wizard"
                        string="Anular FEL"
                        type="object"
                        class="btn-secondary"
                        invisible="l10n_gt_edi_state != 'invoice_sent' or state != 'posted'"
                        groups="account.group_account_invoice"/>
            </xpath>
        </field>
    </record>

    <!-- Reemplazar lista de documentos SAT para mostrar botón siempre -->
    <record id="view_move_form_inherit_sat_list" model="ir.ui.view">
        <field name="name">account.move.form.sat.list</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="l10n_gt_edi.account_move_form_inherit_l10n_gt_edi"/>
        <field name="priority">110</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='l10n_gt_edi_document_ids']/list" position="replace">
                <list create="false" delete="false" edit="false" no_open="1"
                      decoration-danger="state in ('invoice_sending_failed', 'invoice_cancelling_failed')"
                      decoration-success="state == 'invoice_sent'"
                      decoration-warning="state == 'invoice_cancelled'">
                    <field name="message" column_invisible="1"/>
                    <field name="attachment_id" column_invisible="1"/>
                    <field name="datetime"/>
                    <field name="state" widget="account_document_state"/>
                    <field name="uuid"/>
                    <field name="series" optional="hide"/>
                    <field name="serial_number" optional="hide"/>
                    <field name="cancellation_uuid" string="UUID Anulación" optional="hide"/>
                    <button name="action_download_file"
                            type="object"
                            string="Ver XML"
                            icon="fa-file-code-o"
                            invisible="not attachment_id"/>
                </list>
            </xpath>
        </field>
    </record>
</odoo>
